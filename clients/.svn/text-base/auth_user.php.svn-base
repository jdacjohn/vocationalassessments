<?php
	// Get out POST vars
	$success = 0;
	$user = trim($_POST['uname']);
	$password = trim($_POST['pword']);
	$target_url = $_POST['target_url'];
	//print("User = " . $user . "<br />\n");
	//print("PW = " . $password . "<br />\n");
	//  Don't do anything but go back to the login page if either userid or password is missing
	if (!$user || !$password) {
		header("Location: ./login.php?uri=" . $target_url . "&mi=2");
	} else {
		//print("Got past the wtf<br />\n");
		include("../p2952x783E4/connect.php");
 		//connect to db server
 		$dbconn=mysql_connect("$strServer","$strUser","$strPwd") or die("Could not connect to " . $strServer . "  " . mysql_error());
 		if (!empty($dbconn)) {	
   		// Get a DB Instance
   		$dbinst=mysql_select_db("$strDatabase",$dbconn) or die("Coud not connect to Database " . $strDatabase);
      //print("User = " . mysql_real_escape_string($user,$dbconn) . "<br />\n");               
   		if ($dbinst) {		
      	$stmt = "select * from auth_users where username = '" .
								mysql_real_escape_string($user,$dbconn) .
								"' and userpass = password('" .
								mysql_real_escape_string($password) .
								"')";
      	$res = mysql_query($stmt,$dbconn);
				//if (!$res) {
				//	print("something isn't working with the fucking database<br />\n");
				//} else {
				//	print("We should be having some fucking results!<br />\n");
				//}
				$success = mysql_num_rows($res);
				//print("Success = " . $success . "<br />\n");
				if ($success > 0) {
					//print("Success > 0?<br />\n");
					session_start();
					$dbrow = mysql_fetch_array($res);
					$_SESSION['user'] = $user;
					$_SESSION['user_role'] = $dbrow['user_role'];
					$_SESSION['last_req'] = time();
					$stmt2 = "update auth_users set last_login = NOW() where username = '$user' and userpass = password('$password')";
					mysql_query($stmt2,$dbconn);
					$res2 = mysql_affected_rows($dbconn);
					if ($res2 < 1) {
						print("An error occurred updating the DB.  If the problem persists, contact the Website Administrator.");
					}
				}
				mysql_free_result($res);
   		} // End if ($dbinst..
 		} // End if (!empty($dbconn...
 		// close db connection
 		mysql_close($dbconn);
		//print($success);
		if ($success > 0) {
			header("Location: " . $target_url);
		} else {
			header("Location: ./login.php?uri=" . $target_url . "&mi=1");
		}
	} // End If (!user || !password) else
?>
